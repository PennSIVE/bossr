---
title: "Introduction to the bossr pipeline"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  cache = TRUE,
  comment = "#>"
)
```

Install the companion package to follow along the vignette: `install.packages('bossrdata', repos = 'https://pennsive.github.io/drat', type='source')`. 


```{r setup}
library(bossr)
library(bossrdata)
data(oligo)
n.cores = 4
```

The oligo dataset in bossrdata consists of a small 4D segment taken from oligodentrocyte-stained images (TODO: update to correct language).

```{r oligo}
# Oligo is a 4D array
str(oligo)
```

The array functions in bossr are easily parallelizable and detect dimensionality of the input array. `bossr::betamix_img()` produces a threshold for each slice of an array. 

```{r betamix.img}
thr <- bossr::betamix_img(oligo, n.cores = 4)
```

The resulting threshold can be applied with `bossr::threshold_img()`, which produces a mask.

```{r threshold}
mask <- bossr::threshold_img(oligo, thr, n.cores = 4)
```

After thresholding, a `bossr::median_filtering()` can be applied to reduce noise in the mask. 

```{r median_filtering}
system.time(mask_filtered <- bossr::median_filtering(mask))
```

And once the mask has been filtered, `bossr::connect_components()` will detect individual cells via a connected components algorithm. This operation will result in distinct labels being produced.

```{r connect_components}
system.time(labels <- bossr::connect_components(mask_filtered))
```

To produce a description of the location and size of each cell, we use `bossr::track_components()` followed by `bossr::post_process_df()` to perform imputation.

```{r cell_df}
cell_df <- bossr::track_components(labels) |> 
  bossr::post_process_df()
```

A summary of how cell counts change over time can be produced with `bossr::annotate_df()`

```{r annotate_df}
bossr::annotate_df(cell_df, t = 8)
```


```{r, eval=FALSE, include=FALSE, echo=FALSE}
overlay <- bossr::make_overlay(cell_df, dim(oligo), t = 2) |> as.nifti()
nifti_t <- as.nifti(oligo[,,,3])
overlay.nifti(nifti_t,
              overlay,
              #col.y = 
              z = 42,
              plot.type = 'single')


```

